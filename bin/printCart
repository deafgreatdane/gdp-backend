#!/usr/bin/perl
# a utility to pull a receipt from the shopping system.

use File::Path;

# the webapp to pull from
$baseUrl = "http://localhost:8080/shop";
#$baseUrl = "http://kestrel.local:8080/shop";
# for a list of printer names use "lpstat -d -p"
$printer = "Canon_MF4400_Series___osprey";
#$printer = "HP_LaserJet_Professional_P_1102w";
#$printer = "Brother_HL_2270DW_series_2";
#$printer = "Brother_HL_2270DW_series";
# how many copies to print
$numCopies = 0;
# where the receipts are stored
$receiptDir = "/GDP/data/receipts";

# portrait tickets enabled:
$portraitEnabled = 0;
# portrait tickets disabled
#$portraitEnabled = 0;

####################### End of config
mkpath($receiptDir);
chdir($receiptDir);

foreach $cartId ( @ARGV) {

	if ( $cartId < 10 ) {
		# must be a legacy pageCount
		next;
	}
	$pdfName = "cart_${cartId}.pdf";
	
	if ( -e "${pdfName}") {
	    @existingNames = glob("cart_${cartId}.*.pdf");
	    if ( scalar(@existingNames) > 0) {
		$newNumber = 1;
		foreach $name (@existingNames) {
		    $name =~ /\.(\d+)\.pdf/;
		    $number = $1;
		    if ( $newNumber < $number ) {
			$newNumber = $number;
		    }
		}
		$newNumber++;
		$newName = "cart_${cartId}.${newNumber}.pdf";
	    } else {
		$newName = "cart_${cartId}.1.pdf";
	    }
	    rename($pdfName , $newName);
	}
	     
	$command = "/usr/local/bin/wkhtmltopdf -l -s Letter --print-media-type $baseUrl/admin/cart_receipt.do?cartId=$cartId ${receiptDir}/${pdfName}";

	print "$command\n";
	`$command`;

	if ( $numCopies ) {
  		$print = "lp -d $printer -n $numCopies ${receiptDir}/${pdfName}";
		print "$print\n";
		`$print`;
	}

   if ( $portraitEnabled ) {
     $portraitFile = "/tmp/portrait${cartId}.pdf";
	$command = "/usr/local/bin/wkhtmltopdf -l -s Letter --print-media-type $baseUrl/cart_portrait.do?cartId=$cartId $portraitFile";
	print "$command\n";
	`$command`;
	if ( ! $? ) {
 		$command = "lp -d $printer $portraitFile";
		print "$command\n";
		`$command`;
	}
   }
}

